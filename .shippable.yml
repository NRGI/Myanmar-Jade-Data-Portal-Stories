language: node_js

node_js:
  - 6.11.5

branches:
  only:
    - staging
    - master

env:
  global:
    # Shippable API token used to trigger deploy
    - secure: H/uBg0MvtyGpRX5fkmRy12+FvbvSG/TB8iMeZr7AyiF4C7GcQe7DJr6sWZYUmVXyM3JcGsqHah296XfdN63Jdf8TfIrZg2DStdFqlIUw3l/gHakt7ztTnnaBUz+psVXFlZyPzP3d/UdQeCh6Nw+vS2QvqR91XsIw9mXBzijpUzI59KDRvUs+cZKc2+lxIE+OG7Amlq8jIBewnG6r1+UCbe0k2tQWrosnjpWDHE+JsWgugdvEqBpYfHWobXXEKwngzVvWwOhncKFMGtOPvw+kth3+09loL7JsS/+vGWW/s9MevO2N14OyoWw9d/bRbtTKM8U/ixAqmfv+Bp1F8LWNFw==
build:
  ci:
    # Create the version file
    - ./create_version.sh

    # Pull latest image to be used as cache
    - docker pull nrgi/open-jade-data:$BRANCH || echo 'Cache not available'

    # Use the `--cache-from` option to use the latest image in the repo as a cache for this build. Available since Docker 1.13
    # This should speed up the build time.
    - docker build -t nrgi/open-jade-data:$BRANCH.$COMMIT --cache-from nrgi/open-jade-data:$BRANCH .

    # Create the `latest` tag and force it in case the tag is already there from a previous build
    - docker tag nrgi/open-jade-data:$BRANCH.$COMMIT nrgi/open-jade-data:$BRANCH

    - docker push nrgi/open-jade-data:$BRANCH
    - docker push nrgi/open-jade-data:$BRANCH.$COMMIT

    # Trigger deploy through building a repo with deploy configuration
    - ./shippable-deploy.sh
integrations:
  hub:
    - integrationName: nrgiDockerHub
      type: docker
  notifications:
    - integrationName: email
      type: email
      recipients:
        - nrgi@vitaminsoftware.com
      branches:
        only:
          - master
          - staging
      on_success: change
      on_failure: always
